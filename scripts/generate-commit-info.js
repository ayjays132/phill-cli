/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import { execSync } from 'node:child_process';
import { readFileSync, existsSync, mkdirSync, writeFileSync } from 'node:fs';
import { dirname, join, relative } from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const root = join(__dirname, '..');
const scriptPath = relative(root, __filename);

const generatedCliDir = join(root, 'packages/cli/src/generated');
const cliGitCommitFile = join(generatedCliDir, 'git-commit.ts');
const generatedCoreDir = join(root, 'packages/core/src/generated');
const coreGitCommitFile = join(generatedCoreDir, 'git-commit.ts');

let gitCommitInfo = 'N/A';
let cliVersion = 'UNKNOWN';

if (!existsSync(generatedCliDir)) {
  mkdirSync(generatedCliDir, { recursive: true });
}

if (!existsSync(generatedCoreDir)) {
  mkdirSync(generatedCoreDir, { recursive: true });
}

try {
  const gitHash = execSync('git rev-parse --short HEAD', {
    encoding: 'utf-8',
  }).trim();
  if (gitHash) {
    gitCommitInfo = gitHash;
  }

  const cliPkgPath = join(root, 'packages/cli/package.json');
  if (existsSync(cliPkgPath)) {
    const cliPkg = JSON.parse(readFileSync(cliPkgPath, 'utf8'));
    cliVersion = cliPkg.version ?? 'UNKNOWN';
  }
} catch (error) {
  // ignore
}

const fileContent = `/**
 * @license
 * Copyright ${new Date().getUTCFullYear()} Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

// This file is auto-generated by the build script (${scriptPath})
// Do not edit this file manually.
export const GIT_COMMIT_INFO = '${gitCommitInfo}';
export const CLI_VERSION = '${cliVersion}';
`;

writeFileSync(cliGitCommitFile, fileContent);
writeFileSync(coreGitCommitFile, fileContent);
console.log('Phill Build: Successfully generated commit info.');
